<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Push-Up Counter</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <style>
    /* ... (Style tetap sama seperti kode Anda) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    body { background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .container { max-width: 800px; width: 100%; }
    .video-container { position: relative; background: #000; border-radius: 15px; overflow: hidden; width: 100%; aspect-ratio: 4/3; }
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    .overlay-text { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); z-index: 10; padding: 20px; text-align: center; }
    button { padding: 15px 30px; font-size: 1rem; cursor: pointer; border-radius: 50px; border: none; background: #0072ff; color: white; font-weight: bold; }
    .error { color: #ff5555; margin-top: 15px; font-size: 0.9rem; }
    .stats { display: flex; justify-content: space-around; background: #333; padding: 20px; border-radius: 15px; margin-top: 20px; }
    .stat-box { text-align: center; }
    .stat-val { font-size: 2rem; color: #00ff88; font-weight: bold; }
  </style>
</head>
<body>

  <div class="container">
    <h1 style="text-align: center; margin-bottom: 20px;">Push-Up Counter AI</h1>

    <div class="video-container">
      <div id="overlay" class="overlay-text">
        <h2 id="overlay-title">Izin Kamera Diperlukan</h2>
        <p style="margin: 10px 0 20px;">Tekan tombol di bawah untuk mulai menggunakan AI</p>
        <button id="start-btn">AKTIFKAN KAMERA</button>
        <div id="camera-error" class="error"></div>
      </div>
      
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="stats">
      <div class="stat-box">
        <p>Jumlah</p>
        <div id="count" class="stat-val">0</div>
      </div>
      <div class="stat-box">
        <p>Posisi</p>
        <div id="stage" class="stat-val" style="color: #00c6ff;">-</div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start-btn');
    const overlay = document.getElementById('overlay');
    const cameraError = document.getElementById('camera-error');
    
    let detector;
    let count = 0;
    let stage = "up";

    // 1. Cek Protokol HTTPS (Sangat Penting untuk Mobile)
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      cameraError.innerHTML = "<strong>Error:</strong> Akses kamera memerlukan koneksi aman (HTTPS). Silakan gunakan HTTPS.";
      startBtn.disabled = true;
    }

    // 2. Fungsi Utama Request Kamera
    async function setupCamera() {
      try {
        const constraints = {
          video: {
            facingMode: 'user', // Menggunakan kamera depan
            width: { ideal: 640 },
            height: { ideal: 480 }
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      } catch (e) {
        if (e.name === 'NotAllowedError') {
          throw new Error("Izin ditolak. Harap izinkan kamera di pengaturan browser Anda.");
        } else if (e.name === 'NotFoundError') {
          throw new Error("Kamera tidak ditemukan di perangkat ini.");
        } else {
          throw new Error("Gagal mengakses kamera: " + e.message);
        }
      }
    }

    // 3. Inisialisasi Deteksi Pose
    async function initAI() {
      try {
        startBtn.textContent = "MEMUAT AI...";
        startBtn.disabled = true;
        
        detector = await poseDetection.createDetector(
          poseDetection.SupportedModels.MoveNet,
          { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
        );
        
        // Mulai deteksi setelah model siap
        detect();
        overlay.style.display = 'none';
      } catch (e) {
        cameraError.textContent = "Gagal memuat AI. Periksa koneksi internet.";
      }
    }

    // 4. Loop Deteksi
    async function detect() {
      const poses = await detector.estimatePoses(video);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (poses.length > 0) {
        const keypoints = poses[0].keypoints;
        processPushUp(keypoints);
        drawPose(keypoints);
      }
      
      requestAnimationFrame(detect);
    }

    // 5. Logika Hitung Push-Up
    function processPushUp(keypoints) {
      // Ambil titik bahu, siku, pergelangan tangan (kanan)
      const shoulder = keypoints.find(k => k.name === 'right_shoulder');
      const elbow = keypoints.find(k => k.name === 'right_elbow');
      const wrist = keypoints.find(k => k.name === 'right_wrist');

      if (shoulder?.score > 0.3 && elbow?.score > 0.3 && wrist?.score > 0.3) {
        const angle = calculateAngle(shoulder, elbow, wrist);
        
        // Logika sederhana: Down < 90 derajat, Up > 160 derajat
        if (angle < 90) {
          stage = "down";
          document.getElementById('stage').textContent = "DOWN";
        }
        if (angle > 160 && stage === "down") {
          stage = "up";
          count++;
          document.getElementById('count').textContent = count;
          document.getElementById('stage').textContent = "UP";
        }
      }
    }

    function calculateAngle(a, b, c) {
      const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
      let angle = Math.abs((radians * 180.0) / Math.PI);
      if (angle > 180.0) angle = 360 - angle;
      return angle;
    }

    function drawPose(keypoints) {
      keypoints.forEach(kp => {
        if (kp.score > 0.3) {
          ctx.beginPath();
          ctx.arc(kp.x * (canvas.width / video.videoWidth), kp.y * (canvas.height / video.videoHeight), 5, 0, 2 * Math.PI);
          ctx.fillStyle = "#00ff88";
          ctx.fill();
        }
      });
    }

    // EVENT LISTENER: Ini adalah pemicu utama notifikasi muncul
    startBtn.addEventListener('click', async () => {
      cameraError.textContent = "";
      try {
        await setupCamera(); // Pemicu notifikasi browser
        video.play();
        
        // Set ukuran canvas sesuai video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        await initAI();
      } catch (e) {
        cameraError.textContent = e.message;
        startBtn.disabled = false;
        startBtn.textContent = "COBA LAGI";
      }
    });
  </script>
</body>
</html>